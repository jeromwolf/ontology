// Prisma Schema for KSS Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // SQLite for development
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication Models
// ============================================

enum Role {
  GUEST
  STUDENT
  PREMIUM_STUDENT
  INSTRUCTOR
  ADMIN
}

// User model - NextAuth required fields + custom fields
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // OAuth users may not have password
  name          String?
  image         String?
  role          Role      @default(STUDENT)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  profile       Profile?
  enrollments   Enrollment[]
  progress      Progress[]
  submissions   Submission[]
  notifications Notification[]
  learningSession LearningSession[]
  
  @@index([email])
  @@index([role])
}

// Account model - For OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Session model - For managing user sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sessionToken])
}

// Verification Token - For email verification
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User Profile - Extended user information
model Profile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  bio                   String?
  phone                 String?
  organization          String?
  location              String?
  learningGoals         String?
  language              String   @default("ko") // Renamed from preferredLang for consistency
  timezone              String   @default("Asia/Seoul")
  theme                 String   @default("light") // light, dark, system
  
  // Notification preferences
  notifications         Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)
  studyReminders        Boolean  @default(false)
  weeklyReports         Boolean  @default(true)
  contentUpdates        Boolean  @default(true)
  systemAlerts          Boolean  @default(true)
  moduleValidation      Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Learning Progress - Track user's learning progress
model Progress {
  id          String   @id @default(cuid())
  userId      String
  moduleId    String
  chapterId   String
  completed   Boolean  @default(false)
  progress    Int      @default(0) // 0-100
  timeSpent   Int      @default(0) // seconds
  lastAccess  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, moduleId, chapterId])
  @@index([userId])
  @@index([moduleId])
}

// Course Enrollment
model Enrollment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  enrolledAt  DateTime @default(now())
  completedAt DateTime?
  status      String   @default("active") // active, completed, paused
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

// Assignment Submission
model Submission {
  id          String   @id @default(cuid())
  userId      String
  assignmentId String
  content     String
  score       Float?
  feedback    String?
  submittedAt DateTime @default(now())
  gradedAt    DateTime?
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([assignmentId])
}

// ============================================
// Existing Models (News Analysis)
// ============================================

// 뉴스 캐시
model NewsCache {
  id               String   @id @default(cuid())
  query            String   @unique // 검색 쿼리 (캐시 키)
  data             Json     // 뉴스 데이터 + 분석 결과
  priority         String   @default("medium") // high, medium, low
  updateFrequency  Int      // 업데이트 주기 (분)
  hitCount         Int      @default(0) // 조회수
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([query])
  @@index([updatedAt])
}

// 온톨로지 관계
model CompanyRelation {
  id          String   @id @default(cuid())
  companyA    String   // 기업 A
  companyB    String   // 기업 B
  relationType String  // supplier, competitor, partner
  strength    Float    // 관계 강도 (0-1)
  newsCount   Int      // 언급된 뉴스 수
  sentiment   Float    // 평균 감성 점수
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([companyA, companyB, relationType])
  @@index([companyA])
  @@index([companyB])
}

// 기업 영향도
model CompanyImpact {
  id          String   @id @default(cuid())
  company     String   
  ticker      String?
  date        DateTime @default(now())
  directImpact Float   // 직접 영향도
  indirectImpact Float // 간접 영향도
  sectorImpact Float   // 섹터 영향도
  newsCount   Int      // 관련 뉴스 수
  sentiment   Float    // 평균 감성
  keywords    Json     // 주요 키워드 리스트
  
  @@unique([company, date])
  @@index([company])
  @@index([date])
}

// API 호출 로그 (비용 관리)
model ApiCallLog {
  id        String   @id @default(cuid())
  endpoint  String   // newsapi, openai, etc
  query     String?
  cost      Float?   // 예상 비용
  status    String   // success, error
  response  Json?    // 응답 데이터
  createdAt DateTime @default(now())
  
  @@index([endpoint])
  @@index([createdAt])
}

// 사용자 검색 기록
model SearchHistory {
  id        String   @id @default(cuid())
  userId    String?  // 옵션: 사용자 ID
  query     String
  results   Int      // 결과 수
  createdAt DateTime @default(now())
  
  @@index([query])
  @@index([createdAt])
}

// 트렌딩 키워드
model TrendingKeyword {
  id         String   @id @default(cuid())
  keyword    String   @unique
  searchCount Int     @default(1)
  lastSeen   DateTime @default(now())
  category   String?  // 섹터/카테고리
  
  @@index([searchCount])
  @@index([lastSeen])
}

// ============================================
// Notification System Models
// ============================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  CONTENT_UPDATE
  SYSTEM_ALERT
  MODULE_VALIDATION
  STUDY_REMINDER
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  DISMISSED
  EXPIRED
}

// Notification model - Store all user notifications
model Notification {
  id          String             @id @default(cuid())
  userId      String
  type        NotificationType   @default(INFO)
  status      NotificationStatus @default(PENDING)
  title       String
  message     String
  moduleId    String?            // Optional: related to specific module
  chapterId   String?            // Optional: related to specific chapter
  actionUrl   String?            // Optional: URL to redirect when clicked
  metadata    Json?              // Optional: additional data (confidence, source, etc.)
  priority    String             @default("medium") // low, medium, high, critical
  
  // Timing
  createdAt   DateTime           @default(now())
  scheduledAt DateTime?          // For scheduled notifications
  sentAt      DateTime?          // When notification was sent
  readAt      DateTime?          // When user read the notification
  expiresAt   DateTime?          // When notification expires
  
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([moduleId])
}

// Learning Session model - Track detailed learning sessions
model LearningSession {
  id               String   @id @default(cuid())
  userId           String
  moduleId         String
  chapterId        String
  sessionId        String   // Generated session ID for tracking
  
  // Session timing
  startTime        DateTime @default(now())
  endTime          DateTime?
  duration         Int      @default(0) // in seconds
  
  // User interactions
  scrollDepth      Int      @default(0) // 0-100 percentage
  interactionCount Int      @default(0)
  simulatorUsed    Boolean  @default(false)
  bookmarkToggled  Boolean  @default(false)
  
  // Content version tracking
  contentVersion   String?  // Track which version of content was viewed
  lastScrollPosition Int    @default(0)
  
  // Session metadata
  deviceType       String?  // mobile, desktop, tablet
  browserInfo      String?  // browser and version
  referrer         String?  // how user arrived at content
  exitReason       String?  // how session ended
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([moduleId])
  @@index([chapterId])
  @@index([sessionId])
  @@index([startTime])
}

// Content Update Log model - Track all content updates for notification purposes
model ContentUpdate {
  id            String   @id @default(cuid())
  moduleId      String
  chapterId     String?  // null for module-wide updates
  updateType    String   // content, simulator, reference, example, bug_fix
  title         String
  description   String
  previousVersion String?
  currentVersion  String
  
  // Update source and confidence
  source        String?  // GPT-5, Claude, manual, user_feedback
  confidence    Int?     // 0-100 confidence score for AI-generated updates
  validationStatus String @default("pending") // pending, validated, rejected
  
  // Impact assessment
  severity      String   @default("medium") // low, medium, high, breaking
  affectedUsers Int      @default(0) // count of users who viewed old version
  
  // Notification tracking
  notificationsSent Boolean @default(false)
  notifiedUsers     Int     @default(0)
  
  createdAt     DateTime @default(now())
  appliedAt     DateTime? // When update was actually applied
  
  @@index([moduleId])
  @@index([chapterId])
  @@index([createdAt])
  @@index([updateType])
  @@index([validationStatus])
}

// Chapter Version model - Track content versions for change detection
model ChapterVersion {
  id          String   @id @default(cuid())
  moduleId    String
  chapterId   String
  version     String   // semantic version like "1.2.3" 
  contentHash String   // hash of content for change detection
  changelog   String?  // description of changes
  
  // Metadata
  wordCount   Int?
  readingTime Int?     // estimated reading time in minutes
  simulatorCount Int   @default(0)
  
  createdAt   DateTime @default(now())
  publishedAt DateTime?
  deprecatedAt DateTime?
  
  @@unique([moduleId, chapterId, version])
  @@index([moduleId])
  @@index([chapterId])
  @@index([createdAt])
}